name: Deploy to K3s

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
      deploy_method:
        description: "Deployment method"
        required: true
        default: "argocd"
        type: choice
        options:
          - argocd
          - kubectl

concurrency:
  group: deploy-${{ github.event.inputs.environment }}
  cancel-in-progress: false

jobs:
  pre-deploy:
    name: Pre-deploy Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run contract tests
        run: pytest tests/contract/ -v --tb=short

      - name: Validate K8s manifests
        run: |
          curl -sL https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz | tar xz
          sudo mv kubeval /usr/local/bin/
          kubeval --strict --ignore-missing-schemas \
            k8s/security/network-policies.yaml \
            k8s/security/pod-disruption-budgets.yaml

  deploy:
    name: Deploy StreamFlow (${{ github.event.inputs.deploy_method }})
    runs-on: ubuntu-latest
    needs: [pre-deploy]
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.K3S_HOST }} >> ~/.ssh/known_hosts

      - name: Copy kubeconfig
        run: |
          scp ${{ secrets.SSH_USER }}@${{ secrets.K3S_HOST }}:/etc/rancher/k3s/k3s.yaml ./kubeconfig
          sed -i "s/127.0.0.1/${{ secrets.K3S_HOST }}/g" ./kubeconfig

      - name: Deploy via ArgoCD
        if: github.event.inputs.deploy_method == 'argocd'
        env:
          KUBECONFIG: ./kubeconfig
        run: |
          kubectl apply -f k8s/argocd/application.yaml
          echo "ArgoCD application synced. Check ArgoCD dashboard for status."

      - name: Deploy via kubectl
        if: github.event.inputs.deploy_method == 'kubectl'
        env:
          KUBECONFIG: ./kubeconfig
        run: |
          echo "=== Deploying Infrastructure ==="
          cd infra/environments/${{ github.event.inputs.environment }}
          terragrunt run-all init --terragrunt-non-interactive
          terragrunt run-all apply --terragrunt-non-interactive -auto-approve

          echo "=== Applying Security Policies ==="
          kubectl apply -f k8s/security/

          echo "=== Applying K8s Manifests ==="
          kubectl apply -f k8s/kafka/kafka-topics.yaml
          kubectl apply -f k8s/flink/
          kubectl apply -f k8s/monitoring/

      - name: Set up Terraform
        if: github.event.inputs.deploy_method == 'kubectl'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      - name: Verify deployment
        env:
          KUBECONFIG: ./kubeconfig
        run: |
          echo "=== Namespaces ==="
          kubectl get ns | grep streamflow || true
          echo "=== Pods ==="
          kubectl get pods -A | grep streamflow || true
          echo "=== Services ==="
          kubectl get svc -A | grep streamflow || true
          echo "=== Flink Jobs ==="
          kubectl get flinkdeployment -n streamflow-processing || true

  post-deploy:
    name: Post-deploy Smoke Test
    runs-on: ubuntu-latest
    needs: [deploy]
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.K3S_HOST }} >> ~/.ssh/known_hosts

      - name: Copy kubeconfig
        run: |
          scp ${{ secrets.SSH_USER }}@${{ secrets.K3S_HOST }}:/etc/rancher/k3s/k3s.yaml ./kubeconfig
          sed -i "s/127.0.0.1/${{ secrets.K3S_HOST }}/g" ./kubeconfig

      - name: Health check
        env:
          KUBECONFIG: ./kubeconfig
        run: |
          echo "Checking all Flink jobs are running..."
          RUNNING=$(kubectl get flinkdeployment -n streamflow-processing -o jsonpath='{.items[*].status.jobStatus.state}' || echo "unknown")
          echo "Flink job states: $RUNNING"

          echo "Checking Kafka topics exist..."
          kubectl get kafkatopic -n streamflow-kafka || true

          echo "Checking PostgreSQL cluster..."
          kubectl get cluster -n streamflow-data || true
