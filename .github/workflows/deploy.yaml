name: Deploy to K3s

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev

concurrency:
  group: deploy-${{ github.event.inputs.environment }}
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy StreamFlow to K3s
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.K3S_HOST }} >> ~/.ssh/known_hosts

      - name: Copy kubeconfig
        run: |
          scp ${{ secrets.SSH_USER }}@${{ secrets.K3S_HOST }}:/etc/rancher/k3s/k3s.yaml ./kubeconfig
          sed -i "s/127.0.0.1/${{ secrets.K3S_HOST }}/g" ./kubeconfig

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      - name: Set up Terragrunt
        run: |
          curl -sL https://github.com/gruntwork-io/terragrunt/releases/latest/download/terragrunt_linux_amd64 -o /usr/local/bin/terragrunt
          chmod +x /usr/local/bin/terragrunt

      - name: Deploy Infrastructure
        env:
          KUBECONFIG: ./kubeconfig
        working-directory: infra/environments/${{ github.event.inputs.environment }}
        run: |
          terragrunt run-all init --terragrunt-non-interactive
          terragrunt run-all apply --terragrunt-non-interactive -auto-approve

      - name: Apply K8s manifests
        env:
          KUBECONFIG: ./kubeconfig
        run: |
          kubectl apply -f k8s/kafka/kafka-topics.yaml
          kubectl apply -f k8s/flink/
          kubectl apply -f k8s/monitoring/

      - name: Verify deployment
        env:
          KUBECONFIG: ./kubeconfig
        run: |
          echo "=== Namespaces ==="
          kubectl get ns | grep streamflow
          echo "=== Pods ==="
          kubectl get pods -A | grep streamflow
          echo "=== Services ==="
          kubectl get svc -A | grep streamflow
