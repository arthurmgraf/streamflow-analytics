name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install ruff
        run: pip install ruff

      - name: Lint
        run: ruff check src/ tests/ scripts/

      - name: Format check
        run: ruff format --check src/ tests/ scripts/

  typecheck:
    name: Type Check (mypy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Type check
        run: mypy src/ scripts/ --strict

  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml') }}

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Unit tests
        run: pytest tests/unit/ -v --tb=short

      - name: Contract tests
        run: pytest tests/contract/ -v --tb=short

      - name: Integration tests
        run: pytest tests/integration/ -v --tb=short -m "not e2e"

      - name: Coverage report
        if: matrix.python-version == '3.12'
        run: pytest tests/ -v --cov=src --cov-report=term-missing --cov-report=xml --cov-fail-under=80

      - name: Upload coverage
        if: matrix.python-version == '3.12'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -e ".[dev]" pip-audit

      - name: Dependency audit
        run: pip-audit --strict --desc --skip-editable

  dbt-validate:
    name: dbt Compile & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install dbt
        run: pip install dbt-core dbt-postgres dbt-labs/dbt_utils

      - name: dbt deps
        working-directory: dbt
        run: dbt deps --profiles-dir .
        env:
          POSTGRES_PASSWORD: "ci"

      - name: dbt compile (syntax validation)
        working-directory: dbt
        run: dbt compile --profiles-dir . --target dev
        env:
          POSTGRES_HOST: "localhost"
          POSTGRES_PASSWORD: "ci"

  docker-build:
    name: Docker Build Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build PyFlink image
        run: docker build -t streamflow/pyflink:ci -f docker/flink/Dockerfile .

      - name: Build Generator image
        run: docker build -t streamflow/generator:ci -f docker/generator/Dockerfile .

      - name: Build Airflow-dbt image
        run: docker build -t streamflow/airflow-dbt:ci -f docker/airflow/Dockerfile .

  k8s-validate:
    name: K8s Manifest Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kubeval
        run: |
          curl -sL https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz | tar xz
          sudo mv kubeval /usr/local/bin/

      - name: Validate K8s manifests
        run: |
          kubeval --strict --ignore-missing-schemas \
            k8s/kafka/kafka-topics.yaml \
            k8s/security/network-policies.yaml \
            k8s/security/pod-disruption-budgets.yaml \
            k8s/monitoring/service-monitors.yaml \
            k8s/monitoring/alerting-rules.yaml \
            k8s/monitoring/slo-rules.yaml
