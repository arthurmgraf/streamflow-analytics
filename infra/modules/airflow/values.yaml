# ---------------------------------------------------------------------------
# StreamFlow Analytics - Airflow Helm Values Override
# Optimized for K3s single-node deployment with LocalExecutor
# ---------------------------------------------------------------------------

# Executor: LocalExecutor runs tasks in the scheduler process (no workers needed)
executor: "LocalExecutor"

# Custom image with dbt-core + dbt-postgres + astronomer-cosmos
images:
  airflow:
    repository: streamflow/airflow-dbt
    tag: latest
    pullPolicy: Never

# ---------------------------------------------------------------------------
# Webserver
# ---------------------------------------------------------------------------
webserver:
  replicas: 1
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"
  defaultUser:
    enabled: true
    role: Admin
    username: admin
    email: admin@streamflow.local
    firstName: StreamFlow
    lastName: Admin
    # No hardcoded password — set AIRFLOW_ADMIN_PASSWORD env var before deploy
    # kubectl create secret generic airflow-webserver-secret \
    #   --from-literal=password='<secure>' -n streamflow-orchestration
    password: "${AIRFLOW_ADMIN_PASSWORD}"

# ---------------------------------------------------------------------------
# Scheduler
# ---------------------------------------------------------------------------
scheduler:
  replicas: 1
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"

# ---------------------------------------------------------------------------
# Triggerer (disabled - not needed for basic DAGs)
# ---------------------------------------------------------------------------
triggerer:
  enabled: false

# ---------------------------------------------------------------------------
# Flower (disabled - only used with CeleryExecutor)
# ---------------------------------------------------------------------------
flower:
  enabled: false

# ---------------------------------------------------------------------------
# PgBouncer (disabled - not needed for single-node)
# ---------------------------------------------------------------------------
pgbouncer:
  enabled: false

# ---------------------------------------------------------------------------
# Workers (disabled - LocalExecutor runs tasks in the scheduler)
# ---------------------------------------------------------------------------
workers:
  enabled: false

# ---------------------------------------------------------------------------
# DAGs configuration
# ---------------------------------------------------------------------------
dags:
  persistence:
    enabled: false
  gitSync:
    enabled: false

# Extra environment variables for dbt + Cosmos
env:
  - name: DBT_PROJECT_PATH
    value: "/opt/airflow/dbt"

# ---------------------------------------------------------------------------
# Internal PostgreSQL (metadata database)
# ---------------------------------------------------------------------------
postgresql:
  enabled: true
  auth:
    # No hardcoded password — set AIRFLOW_DB_PASSWORD env var before deploy
    # kubectl create secret generic airflow-postgresql-secret \
    #   --from-literal=postgres-password='<secure>' \
    #   --from-literal=password='<secure>' -n streamflow-orchestration
    postgresPassword: "${AIRFLOW_DB_PASSWORD}"
    username: "airflow"
    password: "${AIRFLOW_DB_PASSWORD}"
    database: "airflow"
  primary:
    resources:
      requests:
        cpu: "100m"
        memory: "128Mi"
      limits:
        cpu: "250m"
        memory: "256Mi"
    persistence:
      size: "5Gi"

# ---------------------------------------------------------------------------
# Redis (disabled - only needed for CeleryExecutor)
# ---------------------------------------------------------------------------
redis:
  enabled: false

# ---------------------------------------------------------------------------
# StatsD (disabled to save resources)
# ---------------------------------------------------------------------------
statsd:
  enabled: false

# ---------------------------------------------------------------------------
# Logs
# ---------------------------------------------------------------------------
logs:
  persistence:
    enabled: false
