# SHIPPED: StreamFlow Analytics

> Real-time Streaming Data Platform for E-commerce Fraud Detection

## Metadata

| Attribute | Value |
|-----------|-------|
| **Feature** | STREAMFLOW_ANALYTICS |
| **Shipped** | 2026-02-06 |
| **Author** | Arthur Maia Graf |
| **Phases** | Brainstorm -> Define -> Design -> Build -> Ship |

---

## Summary

Built a complete, production-grade streaming data platform for e-commerce fraud detection. The system processes transaction events via Kafka, detects fraud in real-time using PyFlink with 5 rule-based detectors, persists data in PostgreSQL using Medallion architecture (Bronze/Silver/Gold), orchestrates batch transforms with Airflow, and monitors everything via Prometheus + Grafana.

Deployed on Kubernetes (K3s single-node) using operator-native architecture: Strimzi for Kafka, Flink K8s Operator, and CloudNativePG for PostgreSQL. All infrastructure managed by Terraform + Terragrunt.

---

## Metrics

| Metric | Value |
|--------|-------|
| Total project files | 99 |
| Python source files | 29 |
| Test files | 10 |
| Total tests | 85 (78 unit + 7 e2e) |
| SQL migrations | 4 |
| Terraform modules | 6 |
| K8s manifests | 10 |
| Grafana dashboards | 4 |
| Documentation pages | 5 |
| ADRs | 7 |
| Fraud detection rules | 5 |
| ruff | Zero warnings (strict) |
| mypy | Zero errors (strict) |
| pytest | 85 passed in 0.73s |

---

## Timeline

| Phase | Date | Duration |
|-------|------|----------|
| Brainstorm | 2026-02-06 | ~30 min |
| Define | 2026-02-06 | ~20 min |
| Design | 2026-02-06 | ~45 min |
| Build (8 phases) | 2026-02-06 | ~3 hours |
| Ship | 2026-02-06 | ~15 min |

---

## Key Deliverables

### Code
- 4 Pydantic v2 models (Transaction, Customer, Store, FraudAlert)
- 3 PyFlink jobs (transaction-processor, fraud-detector, realtime-aggregator)
- 5 fraud detection rules with weighted scoring (Welford's algorithm, Haversine)
- 4 Airflow DAGs (bronze_to_silver, silver_to_gold, data_quality, maintenance)
- 5 data generators (customers, stores, transactions, fraud patterns, kafka producer)
- Shared utilities (config loader, structured logging, DB helper)

### Infrastructure
- 6 Terraform modules (namespaces, strimzi-kafka, flink-operator, cloudnativepg, airflow, monitoring)
- 8 Terragrunt configs (DRY, dependency-aware)
- 3 KafkaTopic CRDs, 3 FlinkDeployment CRDs
- 9 PrometheusRule alerts, 3 ServiceMonitors

### Documentation
- Professional README.md with architecture diagrams
- ARCHITECTURE.md with 7 ADRs
- SETUP_GUIDE.md, FRAUD_DETECTION.md, RUNBOOK.md

---

## Lessons Learned

### Process
- Breaking the build into 8 ordered phases prevented dependency confusion
- Running Terraform agents in background while building Python code maximized throughput
- Quality gates (ruff + mypy + pytest) after each major phase caught issues early

### Technical
- Pydantic v2 `field_validator` with `mode="before"` is essential for Decimal coercion from JSON
- mypy strict mode requires explicit `dict[str, Any]` — bare `dict` fails with `[type-arg]`
- ruff N812 rejects `import X as Y` when Y has uppercase — use the original type path instead
- `from datetime import UTC` (not `timezone.utc`) per ruff UP017
- Welford's online algorithm is perfect for streaming stats — no need to store all values
- Haversine formula gives accurate enough distances for fraud detection without heavy geo libraries

### Architecture
- KRaft mode saves ~512MB RAM vs ZooKeeper — critical for resource-constrained nodes
- LocalExecutor for Airflow is perfectly adequate for 4 DAGs on single-node
- Schemas (not databases) for Medallion layers avoids cross-DB FDW complexity
- Monorepo with shared Pydantic models prevents schema drift between Flink and generators

### Tools
- ruff is extremely fast and catches many issues that would only appear in mypy
- Background Task agents are excellent for parallelizing independent file creation
- Strict mypy on all source files ensures type safety across the entire codebase

---

## Artifacts

| Document | Location |
|----------|----------|
| BRAINSTORM | `.claude/sdd/archive/STREAMFLOW_ANALYTICS/BRAINSTORM_STREAMFLOW_ANALYTICS.md` |
| DEFINE | `.claude/sdd/archive/STREAMFLOW_ANALYTICS/DEFINE_STREAMFLOW_ANALYTICS.md` |
| DESIGN | `.claude/sdd/archive/STREAMFLOW_ANALYTICS/DESIGN_STREAMFLOW_ANALYTICS.md` |
| SHIPPED | `.claude/sdd/archive/STREAMFLOW_ANALYTICS/SHIPPED_2026-02-06.md` |
